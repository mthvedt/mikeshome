#!/bin/bash

#Bash script for starting vimclojure and opening a tmux session.
#This turned out more complicated than I initially hoped...

SCRIPTNAME="mngtmux"
DONE_MARK="$SCRIPTNAME is done"

#Startup
OUTFILE=`mktemp -t $SCRIPTNAME` || exit 1
trap "rm -f $OUTFILE" EXIT
{ mvn clojure:nailgun 2>&1 | tee $OUTFILE; echo $DONE_MARK >> $OUTFILE; } &

#wait to start
VCLJ_RESULT="unknown"
while true; do
	if [[ $VCLJ_RESULT != "unknown" ]]; then
		break
	fi
	sleep 1
	# look for the lines that tell us what happened
	while read line; do
		if [[ $line =~ NGServer\ started\ .* ]]; then
			echo "VimClojure is up"
			VCLJ_RESULT="success"
			break
		elif [[ $line =~ $DONE_MARK ]]; then
			echo "aborting"
			for job in `jobs -p`; do kill $job; done
			wait
			exit 1
		fi
	done < <(cat $OUTFILE)
done

#punch line
tmux new-session \; split-window \; split-window \; select-layout even-horizontal \; attach

# Cleanup
echo "Exiting"
for job in `jobs -p`; do kill $job; done
wait
exit 0
